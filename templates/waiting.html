<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <div class="center-container">
        <h2>‚è≥ –í–∞—à —Ñ–∞–π–ª –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ</h2>
        <p id="queue-status">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏...</p>
        <div class="loader"></div>
    </div>

    <script>
        const taskId = "{{ task_id }}";
        let polling = true;

        async function pollStatus() {
            if (!polling) return;

            const res = await fetch(`/queue_status/${taskId}`);
            const data = await res.json();

            if (data.status === "queued") {
                document.getElementById("queue-status").textContent =
                    `–í—ã –≤ –æ—á–µ—Ä–µ–¥–∏: ${data.position}`;
            } else if (data.status === "processing") {
                document.getElementById("queue-status").textContent = "üîß –û–±—Ä–∞–±–æ—Ç–∫–∞...";
            } else if (data.status === "done") {
                polling = false; // –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–ª—å–Ω–µ–π—à–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

                if (data.download) {
                    // —Å–æ–∑–¥–∞—ë–º "—Å–∫—Ä—ã—Ç—É—é" —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                    const a = document.createElement('a');
                    a.href = `/download/${data.transcript_id}`;
                    a.download = '';
                    a.click();

                    // optionally –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    setTimeout(() => {
                        window.location.href = `/view/${data.transcript_id}`;
                    }, 1000);
                } else {
                    window.location.href = `/view/${data.transcript_id}`;
                }
            } else if (data.status === "error") {
                polling = false;
                document.getElementById("queue-status").textContent = "–û—à–∏–±–∫–∞: " + data.message;
            }
        }

        setInterval(pollStatus, 3000);
        pollStatus();
    </script>

</body>

</html>